---
title: "Final Assignment"
output: html_notebook
---

This is an Final Assignment Notebook for EdX Inferential and Modelling course offered by Harvaard University. 

# Assessment for verified learners

Test your inference and modeling skills with this case study analyzing polls from the Brexit referendum! This assessment is available to verified learners only.

# Directions

There are 12 multi-part problems in this comprehensive assessment that review concepts from the entire course. The problems are split over 3 pages. Make sure you read the instructions carefully and run all pre-exercise code.

For numeric entry problems, you have 10 attempts to input the correct answer. For true/false problems, you have 2 attempts.

If you have questions, visit the "Brexit poll analysis" discussion forum that follows the assessment.

IMPORTANT: Some of these exercises use dslabs datasets that were added in a July 2019 update. Make sure your package is up to date with the command install.packages("dslabs").

# Overview

In June 2016, the United Kingdom (UK) held a referendum to determine whether the country would "Remain" in the European Union (EU) or "Leave" the EU. This referendum is commonly known as Brexit. Although the media and others interpreted poll results as forecasting "Remain" (p > 0.5), the actual proportion that voted "Remain" was only 48.1% (p = 0.481) and the UK thus voted to leave the EU. Pollsters in the UK were criticized for overestimating support for "Remain". 

In this project, you will analyze real Brexit polling data to develop polling models to forecast Brexit results. You will write your own code in R and enter the answers on the edX platform.

# Important Definitons

## Data import

Import the brexit_polls polling data from the dslabs package and set options for the analysis:

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# suggested libraries and options
library(tidyverse)
options(digits = 3)

# load brexit_polls object
library(dslabs)
data(brexit_polls)
```

## Final Brexit parameters

Define $p = 0.481$ as the actual percent voting "Remain" on the Brexit referendum and $d = 2p - 1 = -0.038$ as the actual spread of the Brexit referendum with "Remain" defined as the positive outcome:

```{r}
p <- 0.481    # official proportion voting "Remain"
d <- 2*p-1    # official spread
```

## Question 1: Expected value and standard error of a poll

The final proportion of voters choosing "Remain" was $p = 0.481$. Consider a poll with a sample of $N = 1500$ voters.

What is the expected total number of voters in the sample choosing "Remain"?
```{r}
N = 1500
exp_voter <- p * N
exp_voter
```

What is the standard error of the total number of voters in the sample choosing "Remain"?
```{r}
se_voter <- sqrt(N * p * (1 - p))
se_voter
```

What is the expected value of , the proportion of "Remain" voters?
```{r}
E_X <- p
E_X
```

What is the standard error of $\hat{X}$, the proportion of "Remain" voters?
```{r}
se <- sqrt(p * (1 - p) / N)
se
```

What is the expected value of $d$, the spread between the proportion of "Remain" voters and "Leave" voters?
```{r}
d <- (p - (1 - p))
d
```

What is the standard error of , the spread between the proportion of "Remain" voters and "Leave" voters?
```{r}
se_d <- 2 * sqrt(p * (1 - p) / N)
se_d
```


## Question 2: Actual Brexit poll estimates

Load and inspect the `brexit_polls` dataset from ***dslabs***, which contains actual polling data for the 6 months before the Brexit vote. Raw proportions of voters preferring "Remain", "Leave", and "Undecided" are available (`remain`, `leave`, `undecided`) The spread is also available (`spread`), which is the difference in the raw proportion of voters choosing "Remain" and the raw proportion choosing "Leave".

Calculate `x_hat` for each poll, the estimate of the proportion of voters choosing "Remain" on the referendum day $(p = 0.481)$, given the observed `spread` and the relationship $\hat{d} = 2\hat{X} - 1$. Use mutate() to add a variable x_hat to the brexit_polls object by filling in the skeleton code below:
```{r}
brexit_polls <- brexit_polls %>%
        mutate(x_hat = (spread + 1) / 2)
```

What is the average of the observed spreads (`spread`)?
```{r}
mean(brexit_polls$spread)
```

What is the standard deviation of the observed spreads?
```{r}
sd(brexit_polls$spread)
```

What is the average of x_hat, the estimates of the parameter p?
```{r}
mean(brexit_polls$x_hat)
```

What is the standard deviation of `x_hat`?
```{r}
sd(brexit_polls$x_hat)
```

```{r}
brexit_polls %>% group_by(pollster) %>% mutate(x_hat = mean(remain))
```
## Question 3: Confidence interval of a Brexit poll

Consider the first poll in brexit_polls, a YouGov poll run on the same day as the Brexit referendum:
```{r}
brexit_polls[1,]
```
What is the lower bound of the 95% confidence interval?
```{r}
x_hat <- 0.52
N <- 4772
se_hat <- sqrt(x_hat*(1-x_hat)/N)
x_hat - qnorm(.975)*se_hat
```

What is the upper bound of the 95% confidence interval?
```{r}
x_hat <- 0.52
N <- 4772
se_hat <- sqrt(x_hat*(1-x_hat)/N)
x_hat + qnorm(.975)*se_hat
```

# Brexit poll analysis - Part 2

This problem set is continued from the above. Make sure you have run the following code:

```{r}
# suggested libraries
library(tidyverse)

# load brexit_polls object and add x_hat column
library(dslabs)
data(brexit_polls)
brexit_polls <- brexit_polls %>%
    mutate(x_hat = (spread + 1)/2)

# final proportion voting "Remain"
p <- 0.481
```

## Question 4: Confidence intervals for polls in June

Create the data frame `june_polls` containing only Brexit polls ending in June 2016 (`enddate` of "2016-06-01" and later). We will calculate confidence intervals for all polls and determine how many cover the true value of .

First, use mutate() to calculate a plug-in estimate `se_x_hat` for the standard error of the estimate $\hat{SE}[X]$ for each poll given its sample size and value of $\hat{X}$ (`x_hat`). Second, use `mutate()` to calculate an estimate for the standard error of the spread for each poll given the value of `se_x_hat`. Then, use `mutate()` to calculate upper and lower bounds for 95% confidence intervals of the spread. Last, add a column `hit` that indicates whether the confidence interval for each poll covers the correct spread $d = -0.038$.

```{r}
# Creating june_polls
june_polls <- brexit_polls %>%
    filter(enddate >= '2016-06-01') %>%
    mutate(se_x_hat = sqrt(x_hat * (1 - x_hat) / samplesize),
           se_spread = 2 * se_x_hat, 
           lower_spread = spread - se_spread * qnorm(0.975),
           upper_spread = spread + se_spread * qnorm(0.975))
```


How many polls are in june_polls?
```{r}
nrow(june_polls)
```

What proportion of polls have a confidence interval that covers the value 0?
```{r}
mean(june_polls$lower_spread <= 0 & june_polls$upper_spread >= 0)
```

What proportion of polls predict "Remain" (confidence interval entirely above 0)?
```{r}
mean(june_polls$lower_spread > 0)
```

What proportion of polls have a confidence interval covering the true value of $d$?
```{r}
mean(june_polls$lower_spread <= d & june_polls$upper_spread >= d)
```

## Question 5: Hit rate by pollster

Group and summarize the `june_polls` object by pollster to find the proportion of hits for each pollster and the number of polls per pollster. Use `arrange()` to sort by hit rate.

```{r}
june_pollster <- june_polls %>%
    group_by(pollster) %>%
    summarise(hit = mean(lower_spread <= d & upper_spread >= d) / n(),
              hit_n = sum(lower_spread <= d & upper_spread >= d),
              N = sum(n())) %>%
    arrange(desc(hit))
june_pollster
```

## Question 6: Boxplot of Brexit polls by poll type

Make a boxplot of the spread in june_polls by poll type.
```{r}
june_polls %>%
    ggplot(aes(x = poll_type, y = spread)) +
    geom_point() +
    geom_boxplot() +
    ggtitle('Spread vs Type of Polls')
```

## Question 7: Combined spread across poll type

Calculate the confidence intervals of the spread combined across all polls in june_polls, grouping by poll type. Recall that to determine the standard error of the spread, you will need to double the standard error of the estimate.

Use this code (which determines the total sample size per poll type, gives each spread estimate a weight based on the poll's sample size, and adds an estimate of p from the combined spread) to begin your analysis:

```{r}
combined_by_type <- june_polls %>%
        group_by(poll_type) %>%
        summarize(N = sum(samplesize),
                  spread = sum(spread*samplesize)/N,
                  p_hat = (spread + 1)/2)
combined_by_type
```

What is the lower bound of the 95% confidence interval for online voters?
```{r}
online_p_hat <- 0.496
N_online <- 46711
spread_online <- -0.00741
se_spread_online <- 2 * sqrt(online_p_hat * (1 - online_p_hat) / N_online)
lower_spread_online <- spread_online - qnorm(0.975) * se_spread_online
lower_spread_online
```

What is the upper bound of the 95% confidence interval for online voters?
```{r}
online_p_hat <- 0.496
N_online <- 46711
spread_online <- -0.00741
se_spread_online <- 2 * sqrt(online_p_hat * (1 - online_p_hat) / N_online)
upper_spread_online <- spread_online + qnorm(0.975) * se_spread_online
upper_spread_online
```

## Question 8: Interpreting combined spread estimates across poll type

Interpret the confidence intervals for the combined spreads for each poll type calculated in the previous problem.

```{r}
tel_p_hat <- 0.506
N_tel <- 13490
spread_tel <- 0.01273
se_spread_tel <- 2 * sqrt(tel_p_hat * (1 - tel_p_hat) / N_tel)
lower_spread_tel <- spread_tel - qnorm(0.975) * se_spread_tel
upper_spread_tel <- spread_tel + qnorm(0.975) * se_spread_tel

poll_type <- c('online', 'telephonic')
lower <- c(lower_spread_online, lower_spread_tel)
upper <- c(upper_spread_online, upper_spread_tel)
result <- data.frame(poll_type, lower, upper)
result
```


Which of the following are TRUE about the confidence intervals of the combined spreads for different poll types?

### Correct Options
- Neither set of combined polls makes a prediction about the outcome of the Brexit referendum (a prediction is possible if a confidence interval does not cover 0).
- The confidence interval for telephone polls is covers more positive values than the confidence interval for online polls. correct
- Neither confidence interval covers the true value of $d = -0.0038$.

## Brexit poll analysis - Part 3
This problem set is continued from the previous page. Make sure you have run the following code:
```{r}
# suggested libraries
library(tidyverse)

# load brexit_polls object and add x_hat column
library(dslabs)
data(brexit_polls)
brexit_polls <- brexit_polls %>%
    mutate(x_hat = (spread + 1)/2)

# final proportion voting "Remain"
p <- 0.481
```

## Question 9: Chi-squared p-value
Define `brexit_hit`, with the following code, which computes the confidence intervals for all Brexit polls in 2016 and then calculates whether the confidence interval covers the actual value of the spread $d = -0.038$:
```{r}
brexit_hit <- brexit_polls %>%
  mutate(p_hat = (spread + 1)/2,
         se_spread = 2*sqrt(p_hat*(1-p_hat)/samplesize),
         spread_lower = spread - qnorm(.975)*se_spread,
         spread_upper = spread + qnorm(.975)*se_spread,
         hit = spread_lower < -0.038 & spread_upper > -0.038) %>%
  select(poll_type, hit)
brexit_hit
```
Use `brexit_hit` to make a two-by-two table of poll type and hit status. Then use the `chisq.test()` function to perform a chi-squared test to determine whether the difference in hit rate is significant.

What is the p-value of the chi-squared test comparing the hit rate of online and telephone polls?
```{r}
totals <- brexit_hit %>%
    group_by(poll_type, hit) %>%
    summarise(N = sum(hit))

total_count <- brexit_hit %>%
    group_by(poll_type) %>%
    summarise(n())
totals <- spread(totals, hit, N)
totals[1, 2] <- total_count[1, 2] - totals[1, 3]
totals[2, 2] <- total_count[2, 2] - totals[2, 3]

chisq_test <- chisq.test(totals[, 2:3])
chisq_test$p.value
```

Determine which poll type has a higher probability of producing a confidence interval that covers the correct value of the spread. Also determine whether this difference is statistically significant at a p-value cutoff of 0.05. Which of the following is true?
```{r}
odds_online <- (totals[[1,3]] / sum(totals[1, 2:3])) / 
  (totals[[1,2]] / sum(totals[1, 2:3]))
odds_telephone <- (totals[[2,3]] / sum(totals[2, 2:3])) / 
  (totals[[2,2]] / sum(totals[2, 2:3]))
odds_online / odds_telephone
```

## Question 10: Odds ratio of online and telephone poll hit rate

Use the two-by-two table constructed in the previous exercise to calculate the odds ratio between the hit rate of online and telephone polls to determine the magnitude of the difference in performance between the poll types.

Calculate the odds that an online poll generates a confidence interval that covers the actual value of the spread.
```{r}
odds_online <- (totals[[1,3]] / sum(totals[1, 2:3])) / 
  (totals[[1,2]] / sum(totals[1, 2:3]))
odds_online
```

Calculate the odds that a telephone poll generates a confidence interval that covers the actual value of the spread.
```{r}
odds_telephone <- (totals[[2,3]] / sum(totals[2, 2:3])) / 
  (totals[[2,2]] / sum(totals[2, 2:3]))
odds_telephone
```

Calculate the odds ratio to determine how many times larger the odds are for online polls to hit versus telephone polls.
```{r}
odds_online / odds_telephone
```

## Question 11: Plotting spread over time

Use `brexit_polls` to make a plot of the spread (`spread`) over time (`enddate`) colored by poll type (`poll_type`). Use `geom_smooth()` with `method = "loess"` to plot smooth curves with a span of 0.4. Include the individual data points colored by poll type. Add a horizontal line indicating the final value of $d = -0.038$.

```{r}
brexit_polls %>%
    ggplot(aes(x = enddate, y = spread, color=poll_type)) +
    geom_smooth(method = "loess", span = 0.4) +
    geom_point() +
    geom_hline(aes(yintercept = -.038))
```
## Question 12: Plotting raw percentages over time

Use the following code to create the object `brexit_long`, which has a column `vote` containing the three possible votes on a Brexit poll ("remain", "leave", "undecided") and a column `proportion` containing the raw proportion choosing that vote option on the given poll:
```{r}
brexit_long <- brexit_polls %>%
    gather(vote, proportion, "remain":"undecided") %>%
    mutate(vote = factor(vote))
```

Make a graph of proportion over time colored by vote. Add a smooth trendline with geom_smooth() and method = "loess" with a span of 0.3.

```{r}
brexit_long %>%
    ggplot(aes(x = enddate, y = proportion, color=vote)) +
    geom_smooth(method = "loess", span = 0.3) +
    geom_point() +
    geom_hline(aes(yintercept = -.038))
```
Which of the following are TRUE?


### Correct Answers
- The percentage of undecided voters declines over time but is still around 10% throughout June.
- Over most of the date range, the confidence bands for "Leave" and "Remain" overlap.
- Over most of the date range, the confidence bands for "Leave" and "Remain" are below 50%.
- In the first half of June, "Leave" was polling higher than "Remain", although this difference was within the confidence intervals.
